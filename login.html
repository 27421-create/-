<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Savetrack - เข้าสู่ระบบ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ========== ใช้สไตล์เดิมทั้งหมด ========== */
    body{font-family:'Sarabun',sans-serif;margin:0;padding:0;background-color:#F0FFF0;color:#1E5128;display:flex;justify-content:center;align-items:center;min-height:100vh;text-align:center;overflow:hidden}
    .auth-container{background:#fff;padding:40px;border-radius:20px;box-shadow:0 15px 30px rgba(0,0,0,.1);width:90%;max-width:420px;box-sizing:border-box}
    .auth-container h1{color:#28A745;margin-bottom:20px;font-size:2.5em}
    .input-group{margin-bottom:20px;text-align:left;position:relative}
    .input-group label{display:block;margin-bottom:8px;color:#555;font-weight:500}
    .input-group input{width:100%;padding:12px;border:1px solid #ddd;border-radius:12px;box-sizing:border-box;font-size:1em;transition:all .3s}
    .input-group input:focus{border-color:#28A745;box-shadow:0 0 5px rgba(40,167,69,.3);outline:none}
    .password-toggle-icon{position:absolute;top:45px;right:15px;transform:translateY(-50%);cursor:pointer;color:#888;transition:color .3s}
    .password-toggle-icon:hover{color:#333}
    .auth-button{width:100%;padding:15px;background:#28A745;color:#fff;border:none;border-radius:12px;font-size:1.1em;font-weight:bold;cursor:pointer;transition:all .3s;box-shadow:0 5px 15px rgba(40,167,69,.2);margin-top:10px}
    .auth-button:hover{background:#1E5128;box-shadow:0 7px 20px rgba(30,81,40,.3)}
    .google-btn{background:#fff;color:#555;border:1px solid #ccc;display:flex;align-items:center;justify-content:center;gap:10px;box-shadow:0 5px 15px rgba(0,0,0,.1)}
    .google-btn:hover{background:#f5f5f5;box-shadow:0 7px 20px rgba(0,0,0,.15)}
    .google-btn img{height:20px}
    .forgot-password{display:block;margin-top:15px;color:#555;text-decoration:none;font-size:.9em;transition:color .3s}
    .forgot-password:hover{color:#28A745}
    .message{margin-top:15px;padding:12px;border-radius:10px;font-weight:500;display:none}
    .message.success{background:#d4edda;color:#155724}
    .message.error{background:#f8d7da;color:#721c24}
    .bottom-link-container{margin-top:25px;font-size:.9em;color:#555}
    .bottom-link-container a{color:#28A745;text-decoration:none;font-weight:bold}
    .bottom-link-container a:hover{text-decoration:underline}
    .modal{display:none;position:fixed;z-index:1;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.4);padding-top:60px}
    .modal-content{background:#fff;margin:5% auto;padding:20px;border:1px solid #888;width:80%;max-width:400px;text-align:center;border-radius:10px}
    .modal-content .close-button{color:#aaa;float:right;font-size:28px;font-weight:bold}
    .modal-content .close-button:hover,.modal-content .close-button:focus{color:#000;cursor:pointer}
  </style>
</head>
<body>
  <div class="auth-container">
    <h1 class="app-title">Savetrack</h1>
    <h2>เข้าสู่ระบบ</h2>

    <div id="login-form">
      <form id="login-form-inner">
        <div class="input-group">
          <label for="login-email">อีเมล</label>
          <input type="email" id="login-email" placeholder="กรอกอีเมลของคุณ" required>
        </div>
        <div class="input-group">
          <label for="login-password">รหัสผ่าน</label>
          <input type="password" id="login-password" placeholder="กรอกรหัสผ่าน" required>
          <i class="fa-solid fa-eye-slash password-toggle-icon" id="toggle-login-password"></i>
        </div>
        <button type="submit" class="auth-button">เข้าสู่ระบบ</button>
      </form>

      <button id="google-login-btn" class="auth-button google-btn">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo">
        เข้าสู่ระบบด้วย Google
      </button>

      <a href="#" class="forgot-password" id="forgot-password-link">ลืมรหัสผ่าน?</a>
      <div id="login-message" class="message"></div>
    </div>

    <div class="bottom-link-container">
      <p>ยังไม่มีบัญชีใช่ไหม? <a href="signup.html">ลงทะเบียน</a></p>
    </div>
  </div>

  <!-- Modal: reset password -->
  <div id="forgot-password-modal" class="modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <p>กรอกอีเมลของคุณเพื่อรับลิงก์รีเซ็ตรหัสผ่าน:</p>
      <input type="email" id="modal-email-input" style="width:100%;box-sizing:border-box;padding:8px;margin:10px 0;">
      <button id="modal-send-button" class="auth-button" style="width:auto;">ส่ง</button>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import {
      getAuth, setPersistence, browserSessionPersistence,
      signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup,
      onAuthStateChanged, sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCUfR21B9_cPX1XrcmUXp5-AdHzVGhL5c8",
      authDomain: "app-gf-1ee66.firebaseapp.com",
      projectId: "app-gf-1ee66",
      storageBucket: "app-gf-1ee66.firebasestorage.app",
      messagingSenderId: "412479938849",
      appId: "1:412479938849:web:ed0f49c66adb5e60ce1e60",
      measurementId: "G-Y2YBZ2KRBC"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    await setPersistence(auth, browserSessionPersistence); // ปิดเบราว์เซอร์แล้วต้องล็อคอินใหม่

    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" });

    const $ = (s)=>document.querySelector(s);
    const showMsg = (m,t="error")=>{
      const el = $('#login-message'); el.textContent = m; el.className = `message ${t}`; el.style.display='block';
    };

    // toggle eye
    $('#toggle-login-password').addEventListener('click', ()=>{
      const input=$('#login-password'); const icon=$('#toggle-login-password');
      const type=input.getAttribute('type')==='password'?'text':'password';
      input.setAttribute('type', type); icon.classList.toggle('fa-eye-slash'); icon.classList.toggle('fa-eye');
    });

    // email/password
    $('#login-form-inner').addEventListener('submit', async (e)=>{
      e.preventDefault();
      try{
        await signInWithEmailAndPassword(auth, $('#login-email').value.trim(), $('#login-password').value);
      }catch(err){
        const map={
          'auth/invalid-email':'รูปแบบอีเมลไม่ถูกต้อง',
          'auth/user-not-found':'ไม่พบบัญชีนี้',
          'auth/wrong-password':'อีเมลหรือรหัสผ่านไม่ถูกต้อง',
          'auth/unauthorized-domain':'โดเมนนี้ยังไม่ได้อนุญาต (Authorized domains)',
          'auth/operation-not-supported-in-this-environment':'กรุณาเปิดผ่าน http/https (ไม่ใช่ file://)'
        };
        showMsg(map[err.code] || `เกิดข้อผิดพลาด: ${err.code}`);
        console.error(err);
      }
    });

    // Google
    $('#google-login-btn').addEventListener('click', async ()=>{
      try{ await signInWithPopup(auth, provider); }
      catch(err){
        const map={
          'auth/popup-blocked':'เบราว์เซอร์บล็อกป๊อปอัป กรุณาอนุญาต',
          'auth/popup-closed-by-user':'คุณปิดป๊อปอัปก่อนล็อกอิน',
          'auth/unauthorized-domain':'โดเมนนี้ยังไม่ได้อนุญาต (Authorized domains)'
        };
        showMsg(map[err.code] || `Google Sign-in ผิดพลาด: ${err.code}`);
        console.error(err);
      }
    });

    // reset password
    const modal = $('#forgot-password-modal');
    $('#forgot-password-link').addEventListener('click',(e)=>{e.preventDefault();modal.style.display='block';});
    document.querySelector('.close-button').addEventListener('click',()=>modal.style.display='none');
    window.addEventListener('click',(ev)=>{if(ev.target===modal) modal.style.display='none';});
    $('#modal-send-button').addEventListener('click', async ()=>{
      const email=$('#modal-email-input').value.trim();
      if(!email) return showMsg('กรุณากรอกอีเมล');
      try{ await sendPasswordResetEmail(auth,email); showMsg('ส่งลิงก์รีเซ็ตรหัสผ่านไปที่อีเมลแล้ว','success'); modal.style.display='none'; }
      catch(err){ showMsg(`รีเซ็ตรหัสผ่านไม่ได้: ${err.code}`); console.error(err); }
    });

    // ถ้าล็อกอินแล้วให้เข้าหน้าหลัก
    onAuthStateChanged(auth,(user)=>{ if(user) window.location.href='dashboard.html'; });
  </script>
</body>
</html>
